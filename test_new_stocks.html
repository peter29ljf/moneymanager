<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增股票测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>新增股票支持测试</h1>
    
    <div class="test-section info">
        <h3>测试说明</h3>
        <p>这个测试页面验证程序是否能正确处理新增的股票标的。</p>
    </div>
    
    <div class="test-section">
        <h3>测试1: 常见美股</h3>
        <button onclick="testStock('AAPL')">测试 AAPL (苹果)</button>
        <button onclick="testStock('GOOGL')">测试 GOOGL (谷歌)</button>
        <button onclick="testStock('MSFT')">测试 MSFT (微软)</button>
        <div id="result1" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试2: 热门科技股</h3>
        <button onclick="testStock('NVDA')">测试 NVDA (英伟达)</button>
        <button onclick="testStock('TSLA')">测试 TSLA (特斯拉)</button>
        <button onclick="testStock('AMD')">测试 AMD (AMD)</button>
        <div id="result2" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试3: 国际股票</h3>
        <button onclick="testStock('0700.HK')">测试 0700.HK (腾讯)</button>
        <button onclick="testStock('7203.T')">测试 7203.T (丰田)</button>
        <button onclick="testStock('ASML.AS')">测试 ASML.AS (阿斯麦)</button>
        <div id="result3" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试4: ETF</h3>
        <button onclick="testStock('SPY')">测试 SPY (标普500)</button>
        <button onclick="testStock('QQQ')">测试 QQQ (纳斯达克100)</button>
        <button onclick="testStock('VTI')">测试 VTI (全市场)</button>
        <div id="result4" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试5: 自定义股票</h3>
        <input type="text" id="customStock" placeholder="输入股票代码 (如: BABA)" style="padding: 5px; margin-right: 10px;">
        <button onclick="testCustomStock()">测试自定义股票</button>
        <div id="result5" class="result"></div>
    </div>
    
    <div class="test-section success">
        <h3>测试结果总结</h3>
        <div id="summary"></div>
    </div>

    <script>
        const testResults = {};
        
        async function testStock(symbol) {
            const resultDiv = getResultDiv(symbol);
            resultDiv.innerHTML = `正在测试 ${symbol}...`;
            
            try {
                const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        const quote = result.indicators.quote[0];
                        
                        let price = meta.regularMarketPrice;
                        if (!price && quote.close && quote.close.length > 0) {
                            price = quote.close[quote.close.length - 1];
                        }
                        
                        if (price && price > 0) {
                            const companyName = meta.symbol || symbol;
                            resultDiv.innerHTML = `
                                <strong>✅ ${symbol} 测试成功</strong><br>
                                公司: ${companyName}<br>
                                价格: $${price.toFixed(2)}<br>
                                货币: ${meta.currency || 'USD'}<br>
                                交易所: ${meta.exchangeName || 'Unknown'}
                            `;
                            testResults[symbol] = { success: true, price: price };
                        } else {
                            resultDiv.innerHTML = `<strong>❌ ${symbol} 无法获取有效价格</strong>`;
                            testResults[symbol] = { success: false, error: 'No valid price' };
                        }
                    } else {
                        resultDiv.innerHTML = `<strong>❌ ${symbol} API响应格式异常</strong>`;
                        testResults[symbol] = { success: false, error: 'Invalid API response' };
                    }
                } else {
                    resultDiv.innerHTML = `<strong>❌ ${symbol} HTTP错误: ${response.status}</strong>`;
                    testResults[symbol] = { success: false, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                resultDiv.innerHTML = `<strong>❌ ${symbol} 网络错误: ${error.message}</strong>`;
                testResults[symbol] = { success: false, error: error.message };
            }
            
            updateSummary();
        }
        
        function testCustomStock() {
            const symbol = document.getElementById('customStock').value.trim().toUpperCase();
            if (symbol) {
                testStock(symbol);
            } else {
                alert('请输入股票代码');
            }
        }
        
        function getResultDiv(symbol) {
            // 根据股票代码确定结果显示区域
            if (['AAPL', 'GOOGL', 'MSFT'].includes(symbol)) {
                return document.getElementById('result1');
            } else if (['NVDA', 'TSLA', 'AMD'].includes(symbol)) {
                return document.getElementById('result2');
            } else if (['0700.HK', '7203.T', 'ASML.AS'].includes(symbol)) {
                return document.getElementById('result3');
            } else if (['SPY', 'QQQ', 'VTI'].includes(symbol)) {
                return document.getElementById('result4');
            } else {
                return document.getElementById('result5');
            }
        }
        
        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.success).length;
            const failedTests = totalTests - successfulTests;
            
            summaryDiv.innerHTML = `
                <strong>测试统计:</strong><br>
                总测试数: ${totalTests}<br>
                成功: ${successfulTests} ✅<br>
                失败: ${failedTests} ❌<br>
                成功率: ${totalTests > 0 ? ((successfulTests / totalTests) * 100).toFixed(1) : 0}%
            `;
        }
        
        // 页面加载完成后的说明
        window.onload = function() {
            document.getElementById('summary').innerHTML = `
                <strong>测试说明:</strong><br>
                点击任意测试按钮来验证股票API的支持情况。<br>
                所有测试都使用Yahoo Finance免费API，无需密钥。<br>
                测试结果会显示股票价格、公司名称、货币和交易所信息。
            `;
        };
    </script>
</body>
</html>

